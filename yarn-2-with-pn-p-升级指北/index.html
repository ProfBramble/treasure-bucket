<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/treasure-bucket/styles.bddeea5e1f3982d2dba0.css" id="gatsby-global-css">@font-face{font-family:IBM Plex Sans;font-style:normal;font-display:swap;font-weight:100;src:local("IBM Plex Sans Thin "),local("IBM Plex Sans-Thin"),url(/treasure-bucket/static/ibm-plex-sans-latin-100-245539db8ee56425757ef728eda8194e.woff2) format("woff2"),url(/treasure-bucket/static/ibm-plex-sans-latin-100-9a582f3a304f421eca4027517706843c.woff) format("woff")}@font-face{font-family:IBM Plex Sans;font-style:italic;font-display:swap;font-weight:100;src:local("IBM Plex Sans Thin italic"),local("IBM Plex Sans-Thinitalic"),url(/treasure-bucket/static/ibm-plex-sans-latin-100italic-3c34cf080b38f5fb1d4c59ffa45b3967.woff2) format("woff2"),url(/treasure-bucket/static/ibm-plex-sans-latin-100italic-1ea7c5d21b5956b602bdf9656cfb353f.woff) format("woff")}@font-face{font-family:IBM Plex Sans;font-style:normal;font-display:swap;font-weight:200;src:local("IBM Plex Sans Extra Light "),local("IBM Plex Sans-Extra Light"),url(/treasure-bucket/static/ibm-plex-sans-latin-200-bf72c8412ab06c393f52efc5beb26ea7.woff2) format("woff2"),url(/treasure-bucket/static/ibm-plex-sans-latin-200-67524c36348a323f78f2845e3aafc2d4.woff) format("woff")}@font-face{font-family:IBM Plex Sans;font-style:italic;font-display:swap;font-weight:200;src:local("IBM Plex Sans Extra Light italic"),local("IBM Plex Sans-Extra Lightitalic"),url(/treasure-bucket/static/ibm-plex-sans-latin-200italic-bbc2d55223638ce450424a917e1104b2.woff2) format("woff2"),url(/treasure-bucket/static/ibm-plex-sans-latin-200italic-52df25607ec284ca361ae50ba24b3580.woff) format("woff")}@font-face{font-family:IBM Plex Sans;font-style:normal;font-display:swap;font-weight:300;src:local("IBM Plex Sans Light "),local("IBM Plex Sans-Light"),url(/treasure-bucket/static/ibm-plex-sans-latin-300-9e1c48af24191f6ea8aede14957c5d01.woff2) format("woff2"),url(/treasure-bucket/static/ibm-plex-sans-latin-300-10bb6a0ae6dc8000d999ab622a45e281.woff) format("woff")}@font-face{font-family:IBM Plex Sans;font-style:italic;font-display:swap;font-weight:300;src:local("IBM Plex Sans Light italic"),local("IBM Plex Sans-Lightitalic"),url(/treasure-bucket/static/ibm-plex-sans-latin-300italic-c76f2ab53673e964b6e6734c1c455761.woff2) format("woff2"),url(/treasure-bucket/static/ibm-plex-sans-latin-300italic-d3566d5bb4f31d86bfb9fda09563b416.woff) format("woff")}@font-face{font-family:IBM Plex Sans;font-style:normal;font-display:swap;font-weight:400;src:local("IBM Plex Sans Regular "),local("IBM Plex Sans-Regular"),url(/treasure-bucket/static/ibm-plex-sans-latin-400-263d6267533501f58c33b12b382e3abb.woff2) format("woff2"),url(/treasure-bucket/static/ibm-plex-sans-latin-400-a2c56f946488a9a267ba6ba21471a217.woff) format("woff")}@font-face{font-family:IBM Plex Sans;font-style:italic;font-display:swap;font-weight:400;src:local("IBM Plex Sans Regular italic"),local("IBM Plex Sans-Regularitalic"),url(/treasure-bucket/static/ibm-plex-sans-latin-400italic-89a93a1bdde48c7bb104150de88affce.woff2) format("woff2"),url(/treasure-bucket/static/ibm-plex-sans-latin-400italic-272f86114c980c52c131dfc3b4ae3276.woff) format("woff")}@font-face{font-family:IBM Plex Sans;font-style:normal;font-display:swap;font-weight:500;src:local("IBM Plex Sans Medium "),local("IBM Plex Sans-Medium"),url(/treasure-bucket/static/ibm-plex-sans-latin-500-0866c24487514ad726738fb24f8e015b.woff2) format("woff2"),url(/treasure-bucket/static/ibm-plex-sans-latin-500-f6d5c5d5b849796d6a8f5a2953b60753.woff) format("woff")}@font-face{font-family:IBM Plex Sans;font-style:italic;font-display:swap;font-weight:500;src:local("IBM Plex Sans Medium italic"),local("IBM Plex Sans-Mediumitalic"),url(/treasure-bucket/static/ibm-plex-sans-latin-500italic-ffd12d59339823b8cf53b9f99b47d87c.woff2) format("woff2"),url(/treasure-bucket/static/ibm-plex-sans-latin-500italic-ccd41bd1a5bfa8bad2cd8d35fdaeb3d1.woff) format("woff")}@font-face{font-family:IBM Plex Sans;font-style:normal;font-display:swap;font-weight:600;src:local("IBM Plex Sans SemiBold "),local("IBM Plex Sans-SemiBold"),url(/treasure-bucket/static/ibm-plex-sans-latin-600-7852d4dc26ef44df58e23dc0b9722d6f.woff2) format("woff2"),url(/treasure-bucket/static/ibm-plex-sans-latin-600-337b16517a230dc830b84dc6e6167b68.woff) format("woff")}@font-face{font-family:IBM Plex Sans;font-style:italic;font-display:swap;font-weight:600;src:local("IBM Plex Sans SemiBold italic"),local("IBM Plex Sans-SemiBolditalic"),url(/treasure-bucket/static/ibm-plex-sans-latin-600italic-17e5379fd9a99b9bcb26ea983f391b6a.woff2) format("woff2"),url(/treasure-bucket/static/ibm-plex-sans-latin-600italic-6f4ba6aa87fa99d5bc2b90a7b40a0ded.woff) format("woff")}@font-face{font-family:IBM Plex Sans;font-style:normal;font-display:swap;font-weight:700;src:local("IBM Plex Sans Bold "),local("IBM Plex Sans-Bold"),url(/treasure-bucket/static/ibm-plex-sans-latin-700-c9983d3d04f3ed6c2eafee1db1d24e06.woff2) format("woff2"),url(/treasure-bucket/static/ibm-plex-sans-latin-700-b8809d619a33eb825b0450281ff752e7.woff) format("woff")}@font-face{font-family:IBM Plex Sans;font-style:italic;font-display:swap;font-weight:700;src:local("IBM Plex Sans Bold italic"),local("IBM Plex Sans-Bolditalic"),url(/treasure-bucket/static/ibm-plex-sans-latin-700italic-02954beec9e742bb1f3ae27b7e7cb71f.woff2) format("woff2"),url(/treasure-bucket/static/ibm-plex-sans-latin-700italic-72e9af409ddafc63a5dd380e34758560.woff) format("woff")}</style><meta name="generator" content="Gatsby 2.32.13"/><link rel="alternate" type="application/rss+xml" title="ProfBramble -- Blog" href="/treasure-bucket/rss.xml"/><title data-react-helmet="true">Yarn2 with PnP 升级指北 | treasure-bucket</title><link data-react-helmet="true" rel="icon" type="image/png" sizes="32x32" href="/treasure-bucket/favicon-32x32.png"/><link data-react-helmet="true" rel="icon" type="image/png" sizes="16x16" href="/treasure-bucket/favicon-16x16.png"/><link data-react-helmet="true" rel="apple-touch-icon" sizes="180x180" href="/treasure-bucket/apple-touch-icon.png"/><meta data-react-helmet="true" name="description" content="Yarn   作为 JavaScript 生态的一个强大的依赖管理工具，在去年年初就正式发布了 V2 版本，但就当时的表现情况来看稳定性属实不高。时间一晃已经到了 2021 年，随着去年 webpack5 ， vite ， snowpack…"/><meta data-react-helmet="true" name="image" content="https://minimal-blog.lekoarts.de./static/android-chrome-192x192"/><meta data-react-helmet="true" property="og:title" content="Yarn2 with PnP 升级指北"/><meta data-react-helmet="true" property="og:url" content="https://minimal-blog.lekoarts.de/yarn-2-with-pn-p-升级指北"/><meta data-react-helmet="true" property="og:description" content="Yarn   作为 JavaScript 生态的一个强大的依赖管理工具，在去年年初就正式发布了 V2 版本，但就当时的表现情况来看稳定性属实不高。时间一晃已经到了 2021 年，随着去年 webpack5 ， vite ， snowpack…"/><meta data-react-helmet="true" property="og:image" content="https://minimal-blog.lekoarts.de./static/android-chrome-192x192"/><meta data-react-helmet="true" property="og:type" content="website"/><meta data-react-helmet="true" property="og:image:alt" content="Yarn   作为 JavaScript 生态的一个强大的依赖管理工具，在去年年初就正式发布了 V2 版本，但就当时的表现情况来看稳定性属实不高。时间一晃已经到了 2021 年，随着去年 webpack5 ， vite ， snowpack…"/><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"/><meta data-react-helmet="true" name="twitter:title" content="Yarn2 with PnP 升级指北"/><meta data-react-helmet="true" name="twitter:url" content="https://minimal-blog.lekoarts.de/yarn-2-with-pn-p-升级指北"/><meta data-react-helmet="true" name="twitter:description" content="Yarn   作为 JavaScript 生态的一个强大的依赖管理工具，在去年年初就正式发布了 V2 版本，但就当时的表现情况来看稳定性属实不高。时间一晃已经到了 2021 年，随着去年 webpack5 ， vite ， snowpack…"/><meta data-react-helmet="true" name="twitter:image" content="https://minimal-blog.lekoarts.de./static/android-chrome-192x192"/><meta data-react-helmet="true" name="twitter:image:alt" content="Yarn   作为 JavaScript 生态的一个强大的依赖管理工具，在去年年初就正式发布了 V2 版本，但就当时的表现情况来看稳定性属实不高。时间一晃已经到了 2021 年，随着去年 webpack5 ， vite ， snowpack…"/><meta data-react-helmet="true" name="twitter:creator" content="ProfBramble"/><meta data-react-helmet="true" name="gatsby-theme" content="@lekoarts/gatsby-theme-minimal-blog"/><link rel="sitemap" type="application/xml" href="/treasure-bucket/sitemap.xml"/><link rel="manifest" href="/treasure-bucket/manifest.webmanifest" crossorigin="anonymous"/><meta name="theme-color" content="#1890FF"/><link rel="apple-touch-icon" sizes="192x192" href="/treasure-bucket/android-chrome-192x192.png"/><link rel="apple-touch-icon" sizes="512x512" href="/treasure-bucket/android-chrome-512x512.png"/><link as="script" rel="preload" href="/treasure-bucket/webpack-runtime-fbceaeb12a518fe97111.js"/><link as="script" rel="preload" href="/treasure-bucket/framework-305b3707783ccc9d7ca6.js"/><link as="script" rel="preload" href="/treasure-bucket/app-60b63f4aa4ff97feea58.js"/><link as="script" rel="preload" href="/treasure-bucket/styles-e9d24b1846c7d6eb9685.js"/><link as="script" rel="preload" href="/treasure-bucket/3d790d178db05b259e575ef93b2a0dbea1270f59-550e32192ffced72d3f6.js"/><link as="script" rel="preload" href="/treasure-bucket/component---node-modules-lekoarts-gatsby-theme-minimal-blog-core-src-templates-post-query-tsx-57f99312ad0f0ecc6f98.js"/><link as="fetch" rel="preload" href="/treasure-bucket/page-data/yarn-2-with-pn-p-升级指北/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/treasure-bucket/page-data/sq/d/3090400250.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/treasure-bucket/page-data/sq/d/3090400250.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/treasure-bucket/page-data/sq/d/318001574.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/treasure-bucket/page-data/app-data.json" crossorigin="anonymous"/></head><body><script>(function() { try {
  var mode = localStorage.getItem('theme-ui-color-mode');
  if (!mode) return
  document.body.classList.add('theme-ui-' + mode);
} catch (e) {} })();</script><div id="___gatsby"><style data-emotion-css="1hycliv">body{--theme-ui-colors-transparent:var(--theme-ui-colors-transparent,transparent);--theme-ui-colors-black:var(--theme-ui-colors-black,#000);--theme-ui-colors-white:var(--theme-ui-colors-white,#fff);--theme-ui-colors-gray-0:var(--theme-ui-colors-gray-0,null);--theme-ui-colors-gray-1:var(--theme-ui-colors-gray-1,#f7fafc);--theme-ui-colors-gray-2:var(--theme-ui-colors-gray-2,#edf2f7);--theme-ui-colors-gray-3:var(--theme-ui-colors-gray-3,#e2e8f0);--theme-ui-colors-gray-4:var(--theme-ui-colors-gray-4,#cbd5e0);--theme-ui-colors-gray-5:var(--theme-ui-colors-gray-5,#a0aec0);--theme-ui-colors-gray-6:var(--theme-ui-colors-gray-6,#718096);--theme-ui-colors-gray-7:var(--theme-ui-colors-gray-7,#4a5568);--theme-ui-colors-gray-8:var(--theme-ui-colors-gray-8,#2d3748);--theme-ui-colors-gray-9:var(--theme-ui-colors-gray-9,#1a202c);--theme-ui-colors-red-0:var(--theme-ui-colors-red-0,null);--theme-ui-colors-red-1:var(--theme-ui-colors-red-1,#fff5f5);--theme-ui-colors-red-2:var(--theme-ui-colors-red-2,#fed7d7);--theme-ui-colors-red-3:var(--theme-ui-colors-red-3,#feb2b2);--theme-ui-colors-red-4:var(--theme-ui-colors-red-4,#fc8181);--theme-ui-colors-red-5:var(--theme-ui-colors-red-5,#f56565);--theme-ui-colors-red-6:var(--theme-ui-colors-red-6,#e53e3e);--theme-ui-colors-red-7:var(--theme-ui-colors-red-7,#c53030);--theme-ui-colors-red-8:var(--theme-ui-colors-red-8,#9b2c2c);--theme-ui-colors-red-9:var(--theme-ui-colors-red-9,#742a2a);--theme-ui-colors-orange-0:var(--theme-ui-colors-orange-0,null);--theme-ui-colors-orange-1:var(--theme-ui-colors-orange-1,#fffaf0);--theme-ui-colors-orange-2:var(--theme-ui-colors-orange-2,#feebc8);--theme-ui-colors-orange-3:var(--theme-ui-colors-orange-3,#fbd38d);--theme-ui-colors-orange-4:var(--theme-ui-colors-orange-4,#f6ad55);--theme-ui-colors-orange-5:var(--theme-ui-colors-orange-5,#ed8936);--theme-ui-colors-orange-6:var(--theme-ui-colors-orange-6,#dd6b20);--theme-ui-colors-orange-7:var(--theme-ui-colors-orange-7,#c05621);--theme-ui-colors-orange-8:var(--theme-ui-colors-orange-8,#9c4221);--theme-ui-colors-orange-9:var(--theme-ui-colors-orange-9,#7b341e);--theme-ui-colors-yellow-0:var(--theme-ui-colors-yellow-0,null);--theme-ui-colors-yellow-1:var(--theme-ui-colors-yellow-1,#fffff0);--theme-ui-colors-yellow-2:var(--theme-ui-colors-yellow-2,#fefcbf);--theme-ui-colors-yellow-3:var(--theme-ui-colors-yellow-3,#faf089);--theme-ui-colors-yellow-4:var(--theme-ui-colors-yellow-4,#f6e05e);--theme-ui-colors-yellow-5:var(--theme-ui-colors-yellow-5,#ecc94b);--theme-ui-colors-yellow-6:var(--theme-ui-colors-yellow-6,#d69e2e);--theme-ui-colors-yellow-7:var(--theme-ui-colors-yellow-7,#b7791f);--theme-ui-colors-yellow-8:var(--theme-ui-colors-yellow-8,#975a16);--theme-ui-colors-yellow-9:var(--theme-ui-colors-yellow-9,#744210);--theme-ui-colors-green-0:var(--theme-ui-colors-green-0,null);--theme-ui-colors-green-1:var(--theme-ui-colors-green-1,#f0fff4);--theme-ui-colors-green-2:var(--theme-ui-colors-green-2,#c6f6d5);--theme-ui-colors-green-3:var(--theme-ui-colors-green-3,#9ae6b4);--theme-ui-colors-green-4:var(--theme-ui-colors-green-4,#68d391);--theme-ui-colors-green-5:var(--theme-ui-colors-green-5,#48bb78);--theme-ui-colors-green-6:var(--theme-ui-colors-green-6,#38a169);--theme-ui-colors-green-7:var(--theme-ui-colors-green-7,#2f855a);--theme-ui-colors-green-8:var(--theme-ui-colors-green-8,#276749);--theme-ui-colors-green-9:var(--theme-ui-colors-green-9,#22543d);--theme-ui-colors-teal-0:var(--theme-ui-colors-teal-0,null);--theme-ui-colors-teal-1:var(--theme-ui-colors-teal-1,#e6fffa);--theme-ui-colors-teal-2:var(--theme-ui-colors-teal-2,#b2f5ea);--theme-ui-colors-teal-3:var(--theme-ui-colors-teal-3,#81e6d9);--theme-ui-colors-teal-4:var(--theme-ui-colors-teal-4,#4fd1c5);--theme-ui-colors-teal-5:var(--theme-ui-colors-teal-5,#38b2ac);--theme-ui-colors-teal-6:var(--theme-ui-colors-teal-6,#319795);--theme-ui-colors-teal-7:var(--theme-ui-colors-teal-7,#2c7a7b);--theme-ui-colors-teal-8:var(--theme-ui-colors-teal-8,#285e61);--theme-ui-colors-teal-9:var(--theme-ui-colors-teal-9,#234e52);--theme-ui-colors-blue-0:var(--theme-ui-colors-blue-0,null);--theme-ui-colors-blue-1:var(--theme-ui-colors-blue-1,#ebf8ff);--theme-ui-colors-blue-2:var(--theme-ui-colors-blue-2,#bee3f8);--theme-ui-colors-blue-3:var(--theme-ui-colors-blue-3,#90cdf4);--theme-ui-colors-blue-4:var(--theme-ui-colors-blue-4,#63b3ed);--theme-ui-colors-blue-5:var(--theme-ui-colors-blue-5,#4299e1);--theme-ui-colors-blue-6:var(--theme-ui-colors-blue-6,#3182ce);--theme-ui-colors-blue-7:var(--theme-ui-colors-blue-7,#2b6cb0);--theme-ui-colors-blue-8:var(--theme-ui-colors-blue-8,#2c5282);--theme-ui-colors-blue-9:var(--theme-ui-colors-blue-9,#2a4365);--theme-ui-colors-indigo-0:var(--theme-ui-colors-indigo-0,null);--theme-ui-colors-indigo-1:var(--theme-ui-colors-indigo-1,#ebf4ff);--theme-ui-colors-indigo-2:var(--theme-ui-colors-indigo-2,#c3dafe);--theme-ui-colors-indigo-3:var(--theme-ui-colors-indigo-3,#a3bffa);--theme-ui-colors-indigo-4:var(--theme-ui-colors-indigo-4,#7f9cf5);--theme-ui-colors-indigo-5:var(--theme-ui-colors-indigo-5,#667eea);--theme-ui-colors-indigo-6:var(--theme-ui-colors-indigo-6,#5a67d8);--theme-ui-colors-indigo-7:var(--theme-ui-colors-indigo-7,#4c51bf);--theme-ui-colors-indigo-8:var(--theme-ui-colors-indigo-8,#434190);--theme-ui-colors-indigo-9:var(--theme-ui-colors-indigo-9,#3c366b);--theme-ui-colors-purple-0:var(--theme-ui-colors-purple-0,null);--theme-ui-colors-purple-1:var(--theme-ui-colors-purple-1,#faf5ff);--theme-ui-colors-purple-2:var(--theme-ui-colors-purple-2,#e9d8fd);--theme-ui-colors-purple-3:var(--theme-ui-colors-purple-3,#d6bcfa);--theme-ui-colors-purple-4:var(--theme-ui-colors-purple-4,#b794f4);--theme-ui-colors-purple-5:var(--theme-ui-colors-purple-5,#9f7aea);--theme-ui-colors-purple-6:var(--theme-ui-colors-purple-6,#805ad5);--theme-ui-colors-purple-7:var(--theme-ui-colors-purple-7,#6b46c1);--theme-ui-colors-purple-8:var(--theme-ui-colors-purple-8,#553c9a);--theme-ui-colors-purple-9:var(--theme-ui-colors-purple-9,#44337a);--theme-ui-colors-pink-0:var(--theme-ui-colors-pink-0,null);--theme-ui-colors-pink-1:var(--theme-ui-colors-pink-1,#fff5f7);--theme-ui-colors-pink-2:var(--theme-ui-colors-pink-2,#fed7e2);--theme-ui-colors-pink-3:var(--theme-ui-colors-pink-3,#fbb6ce);--theme-ui-colors-pink-4:var(--theme-ui-colors-pink-4,#f687b3);--theme-ui-colors-pink-5:var(--theme-ui-colors-pink-5,#ed64a6);--theme-ui-colors-pink-6:var(--theme-ui-colors-pink-6,#d53f8c);--theme-ui-colors-pink-7:var(--theme-ui-colors-pink-7,#b83280);--theme-ui-colors-pink-8:var(--theme-ui-colors-pink-8,#97266d);--theme-ui-colors-pink-9:var(--theme-ui-colors-pink-9,#702459);--theme-ui-colors-grayDark:var(--theme-ui-colors-grayDark,#2d3748);--theme-ui-colors-text:var(--theme-ui-colors-text,#2d3748);--theme-ui-colors-background:var(--theme-ui-colors-background,#fff);--theme-ui-colors-primary:var(--theme-ui-colors-primary,#6b46c1);--theme-ui-colors-primaryHover:var(--theme-ui-colors-primaryHover,#2c5282);--theme-ui-colors-secondary:var(--theme-ui-colors-secondary,#5f6c80);--theme-ui-colors-muted:var(--theme-ui-colors-muted,#e2e8f0);--theme-ui-colors-success:var(--theme-ui-colors-success,#9ae6b4);--theme-ui-colors-info:var(--theme-ui-colors-info,#63b3ed);--theme-ui-colors-warning:var(--theme-ui-colors-warning,#faf089);--theme-ui-colors-danger:var(--theme-ui-colors-danger,#feb2b2);--theme-ui-colors-light:var(--theme-ui-colors-light,#f7fafc);--theme-ui-colors-dark:var(--theme-ui-colors-dark,#2d3748);--theme-ui-colors-textMuted:var(--theme-ui-colors-textMuted,#718096);--theme-ui-colors-toggleIcon:var(--theme-ui-colors-toggleIcon,#2d3748);--theme-ui-colors-heading:var(--theme-ui-colors-heading,#000);--theme-ui-colors-divide:var(--theme-ui-colors-divide,#cbd5e0);color:var(--theme-ui-colors-text,#2d3748);background-color:var(--theme-ui-colors-background,#fff);}body.theme-ui-dark{--theme-ui-colors-text:var(--theme-ui-colors-modes-dark-text,#cbd5e0);--theme-ui-colors-primary:var(--theme-ui-colors-modes-dark-primary,#9f7aea);--theme-ui-colors-secondary:var(--theme-ui-colors-modes-dark-secondary,#7f8ea3);--theme-ui-colors-toggleIcon:var(--theme-ui-colors-modes-dark-toggleIcon,#cbd5e0);--theme-ui-colors-background:var(--theme-ui-colors-modes-dark-background,#1A202C);--theme-ui-colors-heading:var(--theme-ui-colors-modes-dark-heading,#fff);--theme-ui-colors-divide:var(--theme-ui-colors-modes-dark-divide,#2d3748);--theme-ui-colors-muted:var(--theme-ui-colors-modes-dark-muted,#2d3748);}</style><style data-emotion-css="tm2q0o">*{box-sizing:border-box;}body{margin:0;font-family:"IBM Plex Sans",-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";line-height:1.625;font-weight:400;color:var(--theme-ui-colors-text,#2d3748);background-color:var(--theme-ui-colors-background,#fff);padding:0;box-sizing:border-box;text-rendering:optimizeLegibility;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;}</style><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><style data-emotion-css="kcr4c7">*{box-sizing:inherit;}html{-webkit-text-size-adjust:100%;}img{border-style:none;}pre{font-family:monospace;font-size:1em;}[hidden]{display:none;}::selection{background-color:var(--theme-ui-colors-text,#2d3748);color:var(--theme-ui-colors-background,#fff);}a{-webkit-transition:all 0.3s ease-in-out;transition:all 0.3s ease-in-out;color:text;}</style><style data-emotion-css="1g597hz">.css-1g597hz{border:0;-webkit-clip:react(0 0 0 0);clip:react(0 0 0 0);height:1px;width:1px;margin:-1px;padding:0;overflow:hidden;position:absolute;}.css-1g597hz:focus{padding:1rem;position:fixed;top:15px;left:15px;background-color:var(--theme-ui-colors-heading,#000);color:var(--theme-ui-colors-background,#fff);z-index:1;width:auto;height:auto;-webkit-clip:auto;clip:auto;-webkit-text-decoration:none;text-decoration:none;}</style><a href="#skip-nav" data-skip-link="true" class="css-1g597hz">Skip to content</a><style data-emotion-css="1jrqzhj">.css-1jrqzhj{box-sizing:border-box;margin:0;min-width:0;width:100%;max-width:container;margin-left:auto;margin-right:auto;padding:1rem;max-width:1024px;}@media screen and (min-width:640px){.css-1jrqzhj{padding:2rem;}}</style><div class="css-1jrqzhj"><style data-emotion-css="1wt4r56">.css-1wt4r56{margin-bottom:4rem;}@media screen and (min-width:640px){.css-1wt4r56{margin-bottom:8rem;}}</style><header class="css-1wt4r56"><style data-emotion-css="1eswzqe">.css-1eswzqe{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;}</style><style data-emotion-css="190uhut">.css-190uhut{box-sizing:border-box;margin:0;min-width:0;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;}</style><div class="css-190uhut"><style data-emotion-css="dz3ojy">.css-dz3ojy{color:var(--theme-ui-colors-heading,#000);-webkit-text-decoration:none;text-decoration:none;}</style><a aria-label="treasure-bucket - Back to home" class="css-dz3ojy" href="/treasure-bucket/"><style data-emotion-css="1kmktz0">.css-1kmktz0{margin-top:0;margin-bottom:0;font-weight:500;font-size:1.5rem;}@media screen and (min-width:640px){.css-1kmktz0{font-size:1.875rem;}}</style><div class="css-1kmktz0">treasure-bucket</div></a><style data-emotion-css="af3ja4">.css-af3ja4{opacity:0.65;position:relative;border-radius:5px;width:40px;height:25px;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-transition:opacity 0.3s ease;transition:opacity 0.3s ease;border:none;outline:none;background:none;cursor:pointer;padding:0;-webkit-appearance:none;-moz-appearance:none;appearance:none;}.css-af3ja4:hover,.css-af3ja4:focus{opacity:1;}</style><button type="button" aria-label="Activate Dark Mode" title="Activate Dark Mode" class="css-af3ja4"><style data-emotion-css="iiu7h7">.css-iiu7h7{position:relative;width:24px;height:24px;border-radius:50%;border:none;background-color:var(--theme-ui-colors-transparent,transparent);-webkit-transform:scale(1);-ms-transform:scale(1);transform:scale(1);-webkit-transition:all 0.45s ease;transition:all 0.45s ease;overflow:hidden;box-shadow:inset 8px -8px 0px 0px var(--theme-ui-colors-toggleIcon,#2d3748);}.css-iiu7h7:before{content:"";position:absolute;right:-9px;top:-9px;height:24px;width:24px;border:none;border-radius:50%;-webkit-transform:translate(0,0);-ms-transform:translate(0,0);transform:translate(0,0);opacity:1;-webkit-transition:-webkit-transform 0.45s ease;-webkit-transition:transform 0.45s ease;transition:transform 0.45s ease;}.css-iiu7h7:after{content:"";width:8px;height:8px;border-radius:50%;margin:-4px 0 0 -4px;position:absolute;top:50%;left:50%;box-shadow:0 -23px 0 var(--theme-ui-colors-toggleIcon,#2d3748),0 23px 0 var(--theme-ui-colors-toggleIcon,#2d3748),23px 0 0 var(--theme-ui-colors-toggleIcon,#2d3748),-23px 0 0 var(--theme-ui-colors-toggleIcon,#2d3748),15px 15px 0 var(--theme-ui-colors-toggleIcon,#2d3748),-15px 15px 0 var(--theme-ui-colors-toggleIcon,#2d3748),15px -15px 0 var(--theme-ui-colors-toggleIcon,#2d3748),-15px -15px 0 var(--theme-ui-colors-toggleIcon,#2d3748);-webkit-transform:scale(0);-ms-transform:scale(0);transform:scale(0);-webkit-transition:all 0.35s ease;transition:all 0.35s ease;}</style><div class="css-iiu7h7"></div></button></div><style data-emotion-css="1kvspmd">.css-1kvspmd{box-sizing:border-box;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;border-bottom-style:solid;border-bottom-width:1px;border-bottom-color:var(--theme-ui-colors-divide,#cbd5e0);padding-bottom:1rem;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;margin-top:1rem;color:var(--theme-ui-colors-secondary,#5f6c80);-webkit-flex-flow:wrap;-ms-flex-flow:wrap;flex-flow:wrap;}.css-1kvspmd a{color:var(--theme-ui-colors-secondary,#5f6c80);}.css-1kvspmd a:hover{color:var(--theme-ui-colors-heading,#000);}</style><div class="css-1kvspmd"><style data-emotion-css="nrb238">.css-nrb238{font-size:1rem;}.css-nrb238 a:not(:last-of-type){margin-right:1rem;}@media screen and (min-width:640px){.css-nrb238{font-size:18px;}}.css-nrb238 .active{color:var(--theme-ui-colors-heading,#000);}</style><nav class="css-nrb238"><style data-emotion-css="688a3f">.css-688a3f{box-sizing:border-box;margin:0;min-width:0;color:var(--theme-ui-colors-primary,#6b46c1);-webkit-text-decoration:none;text-decoration:none;}.css-688a3f:hover{-webkit-text-decoration:underline;text-decoration:underline;}</style><a class="css-688a3f" href="/treasure-bucket/blog">Blog</a><a class="css-688a3f" href="/treasure-bucket/about">About</a></nav><style data-emotion-css="e5k4e3">.css-e5k4e3{font-size:1rem;}.css-e5k4e3 a:not(:first-of-type){margin-left:1rem;}@media screen and (min-width:640px){.css-e5k4e3{font-size:18px;}}</style><div class="css-e5k4e3"><a href="https://www.zhihu.com/people/prof-bramble" class="css-688a3f">知乎</a><a href="https://juejin.cn/user/3491704661881629" class="css-688a3f">掘金</a></div></div></header><style data-emotion-css="1o6dm8k">.css-1o6dm8k [data-name='live-editor']{font-size:1rem;}.css-1o6dm8k [data-name='live-editor'] textarea,.css-1o6dm8k [data-name='live-editor'] pre{padding:1rem !important;}.css-1o6dm8k [data-name='live-preview']{padding:calc(0.5rem + 10px) !important;background-color:#d2c7ec;}.css-1o6dm8k .prism-code{font-size:1rem;padding:2rem 1rem 1rem 1rem;webkit-overflow-scrolling:touch;background-color:var(--theme-ui-colors-transparent,transparent);min-width:100%;margin-bottom:0;margin-top:0;overflow:auto;}@media screen and (min-width:640px){.css-1o6dm8k .prism-code{font-size:1rem;}}@media screen and (min-width:768px){.css-1o6dm8k .prism-code{font-size:1.25rem;}}.css-1o6dm8k .prism-code[data-linenumber="false"] .token-line{padding-left:1rem;}.css-1o6dm8k .gatsby-highlight[data-language=''] .prism-code,.css-1o6dm8k .gatsby-highlight[data-language='noLineNumbers'] .prism-code{padding-top:1rem;}.css-1o6dm8k .token{display:inline-block;}.css-1o6dm8k p > code,.css-1o6dm8k li > code{background-color:var(--theme-ui-colors-gray-2,#edf2f7);color:var(--theme-ui-colors-gray-8,#2d3748);padding-left:0.5rem;padding-right:0.5rem;padding-top:0.25rem;padding-bottom:0.25rem;border-radius:2px;}.css-1o6dm8k .gatsby-highlight{font-size:1rem;position:relative;webkit-overflow-scrolling:touch;background-color:rgb(1,22,39);border-radius:2px;margin-left:0;margin-right:0;}@media screen and (min-width:640px){.css-1o6dm8k .gatsby-highlight{font-size:1rem;margin-left:0;margin-right:0;}}@media screen and (min-width:768px){.css-1o6dm8k .gatsby-highlight{font-size:1.25rem;margin-left:0;margin-right:0;}}@media screen and (min-width:1024px){.css-1o6dm8k .gatsby-highlight{margin-left:-1rem;margin-right:-1rem;}}.css-1o6dm8k .gatsby-highlight .token-line{margin-left:-1rem;margin-right:-1rem;min-width:100%;}.css-1o6dm8k .gatsby-highlight pre code{float:left;min-width:100%;}.css-1o6dm8k .gatsby-highlight pre[class*="language-"]:before{background-color:var(--theme-ui-colors-white,#fff);border-radius:0 0 0.25rem 0.25rem;color:var(--theme-ui-colors-black,#000);font-size:12px;-webkit-letter-spacing:0.025rem;-moz-letter-spacing:0.025rem;-ms-letter-spacing:0.025rem;letter-spacing:0.025rem;padding:0.1rem 0.5rem;position:absolute;left:1rem;text-align:right;text-transform:uppercase;top:0;}.css-1o6dm8k .gatsby-highlight pre[class~="language-javascript"]:before,.css-1o6dm8k .gatsby-highlight pre[class~="language-js"]:before{content:"js";background:#f7df1e;color:var(--theme-ui-colors-black,#000);}.css-1o6dm8k .gatsby-highlight pre[class~="language-jsx"]:before{content:"jsx";background:#61dafb;color:var(--theme-ui-colors-black,#000);}.css-1o6dm8k .gatsby-highlight pre[class~="language-ts"]:before{content:"ts";background:#61dafb;color:var(--theme-ui-colors-black,#000);}.css-1o6dm8k .gatsby-highlight pre[class~="language-tsx"]:before{content:"tsx";background:#61dafb;color:var(--theme-ui-colors-black,#000);}.css-1o6dm8k .gatsby-highlight pre[class~="language-html"]:before{content:"html";background:#005a9c;color:var(--theme-ui-colors-white,#fff);}.css-1o6dm8k .gatsby-highlight pre[class~="language-xml"]:before{content:"xml";background:#005a9c;color:var(--theme-ui-colors-white,#fff);}.css-1o6dm8k .gatsby-highlight pre[class~="language-svg"]:before{content:"svg";background:#005a9c;color:var(--theme-ui-colors-white,#fff);}.css-1o6dm8k .gatsby-highlight pre[class~="language-graphql"]:before{content:"GraphQL";background:#E10098;}.css-1o6dm8k .gatsby-highlight pre[class~="language-css"]:before{content:"css";background:#ff9800;color:var(--theme-ui-colors-black,#000);}.css-1o6dm8k .gatsby-highlight pre[class~="language-mdx"]:before{content:"mdx";background:#f9ac00;color:var(--theme-ui-colors-black,#000);}.css-1o6dm8k .gatsby-highlight pre[class~="language-php"]:before{content:"php";background:#777bb3;color:var(--theme-ui-colors-black,#000);}.css-1o6dm8k .gatsby-highlight pre[class~="language-py"]:before,.css-1o6dm8k .gatsby-highlight pre[class~="language-python"]:before{content:"py";background:#306998;color:var(--theme-ui-colors-white,#fff);}.css-1o6dm8k .gatsby-highlight pre[class~="language-text"]:before{content:"text";}.css-1o6dm8k .gatsby-highlight pre[class~='language-shell']:before{content:'shell';}.css-1o6dm8k .gatsby-highlight pre[class~='language-sh']:before{content:'sh';}.css-1o6dm8k .gatsby-highlight pre[class~='language-bash']:before{content:'bash';}.css-1o6dm8k .gatsby-highlight pre[class~='language-yaml']:before{content:'yaml';background:#ffa8df;}.css-1o6dm8k .gatsby-highlight pre[class~='language-yml']:before{content:'yml';background:#ffa8df;}.css-1o6dm8k .gatsby-highlight pre[class~='language-markdown']:before{content:'md';}.css-1o6dm8k .gatsby-highlight pre[class~='language-json']:before,.css-1o6dm8k .gatsby-highlight pre[class~='language-json5']:before{content:'json';background:linen;}.css-1o6dm8k .gatsby-highlight pre[class~='language-diff']:before{content:'diff';background:#e6ffed;}.css-1o6dm8k .gatsby-highlight > code[class*="language-"],.css-1o6dm8k .gatsby-highlight > pre[class=*="language-"]{word-spacing:normal;word-break:normal;overflow-wrap:normal;line-height:1.5;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;}.css-1o6dm8k .gatsby-highlight pre::-webkit-scrollbar{width:0.5rem;height:0.5rem;}.css-1o6dm8k .gatsby-highlight pre::-webkit-scrollbar-thumb{background-color:var(--theme-ui-colors-primary,#6b46c1);}.css-1o6dm8k .gatsby-highlight pre::-webkit-scrollbar-track{background:rgb(1,22,39);}.css-1o6dm8k .line-number-style{display:inline-block;width:3em;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;opacity:0.3;text-align:center;position:relative;}.css-1o6dm8k .code-title{background-color:#d2c7ec;color:var(--theme-ui-colors-black,#000);font-size:0.875rem;padding-left:1rem;padding-right:1rem;padding-top:0.5rem;padding-bottom:0.5rem;font-family:Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;margin-left:0;margin-right:0;}@media screen and (min-width:640px){.css-1o6dm8k .code-title{margin-left:0;margin-right:0;}}@media screen and (min-width:768px){.css-1o6dm8k .code-title{margin-left:0;margin-right:0;}}@media screen and (min-width:1024px){.css-1o6dm8k .code-title{margin-left:-1rem;margin-right:-1rem;}}.css-1o6dm8k [data-name='live-preview'],.css-1o6dm8k [data-name='live-editor']{margin-left:0;margin-right:0;font-size:1rem;}@media screen and (min-width:640px){.css-1o6dm8k [data-name='live-preview'],.css-1o6dm8k [data-name='live-editor']{margin-left:0;margin-right:0;font-size:1rem;}}@media screen and (min-width:768px){.css-1o6dm8k [data-name='live-preview'],.css-1o6dm8k [data-name='live-editor']{margin-left:0;margin-right:0;font-size:1.25rem;}}@media screen and (min-width:1024px){.css-1o6dm8k [data-name='live-preview'],.css-1o6dm8k [data-name='live-editor']{margin-left:-1rem;margin-right:-1rem;}}.css-1o6dm8k .token-line{padding-right:1rem;}.css-1o6dm8k .highlight-line{background-color:rgb(2,55,81);border-left:4px solid rgb(2,155,206);}.css-1o6dm8k .highlight-line .line-number-style{width:calc(3em - 4px);opacity:0.5;left:-2px;}.css-1o6dm8k .react-live-wrapper{position:relative;}.css-1o6dm8k .react-live-wrapper .code-copy-button{right:0;}@media screen and (min-width:640px){.css-1o6dm8k .react-live-wrapper .code-copy-button{right:0;}}@media screen and (min-width:768px){.css-1o6dm8k .react-live-wrapper .code-copy-button{right:0;}}@media screen and (min-width:1024px){.css-1o6dm8k .react-live-wrapper .code-copy-button{right:-1rem;}}</style><style data-emotion-css="1mcymz">.css-1mcymz{box-sizing:border-box;margin:0;min-width:0;}.css-1mcymz [data-name='live-editor']{font-size:1rem;}.css-1mcymz [data-name='live-editor'] textarea,.css-1mcymz [data-name='live-editor'] pre{padding:1rem !important;}.css-1mcymz [data-name='live-preview']{padding:calc(0.5rem + 10px) !important;background-color:#d2c7ec;}.css-1mcymz .prism-code{font-size:1rem;padding:2rem 1rem 1rem 1rem;webkit-overflow-scrolling:touch;background-color:var(--theme-ui-colors-transparent,transparent);min-width:100%;margin-bottom:0;margin-top:0;overflow:auto;}@media screen and (min-width:640px){.css-1mcymz .prism-code{font-size:1rem;}}@media screen and (min-width:768px){.css-1mcymz .prism-code{font-size:1.25rem;}}.css-1mcymz .prism-code[data-linenumber="false"] .token-line{padding-left:1rem;}.css-1mcymz .gatsby-highlight[data-language=''] .prism-code,.css-1mcymz .gatsby-highlight[data-language='noLineNumbers'] .prism-code{padding-top:1rem;}.css-1mcymz .token{display:inline-block;}.css-1mcymz p > code,.css-1mcymz li > code{background-color:var(--theme-ui-colors-gray-2,#edf2f7);color:var(--theme-ui-colors-gray-8,#2d3748);padding-left:0.5rem;padding-right:0.5rem;padding-top:0.25rem;padding-bottom:0.25rem;border-radius:2px;}.css-1mcymz .gatsby-highlight{font-size:1rem;position:relative;webkit-overflow-scrolling:touch;background-color:rgb(1,22,39);border-radius:2px;margin-left:0;margin-right:0;}@media screen and (min-width:640px){.css-1mcymz .gatsby-highlight{font-size:1rem;margin-left:0;margin-right:0;}}@media screen and (min-width:768px){.css-1mcymz .gatsby-highlight{font-size:1.25rem;margin-left:0;margin-right:0;}}@media screen and (min-width:1024px){.css-1mcymz .gatsby-highlight{margin-left:-1rem;margin-right:-1rem;}}.css-1mcymz .gatsby-highlight .token-line{margin-left:-1rem;margin-right:-1rem;min-width:100%;}.css-1mcymz .gatsby-highlight pre code{float:left;min-width:100%;}.css-1mcymz .gatsby-highlight pre[class*="language-"]:before{background-color:var(--theme-ui-colors-white,#fff);border-radius:0 0 0.25rem 0.25rem;color:var(--theme-ui-colors-black,#000);font-size:12px;-webkit-letter-spacing:0.025rem;-moz-letter-spacing:0.025rem;-ms-letter-spacing:0.025rem;letter-spacing:0.025rem;padding:0.1rem 0.5rem;position:absolute;left:1rem;text-align:right;text-transform:uppercase;top:0;}.css-1mcymz .gatsby-highlight pre[class~="language-javascript"]:before,.css-1mcymz .gatsby-highlight pre[class~="language-js"]:before{content:"js";background:#f7df1e;color:var(--theme-ui-colors-black,#000);}.css-1mcymz .gatsby-highlight pre[class~="language-jsx"]:before{content:"jsx";background:#61dafb;color:var(--theme-ui-colors-black,#000);}.css-1mcymz .gatsby-highlight pre[class~="language-ts"]:before{content:"ts";background:#61dafb;color:var(--theme-ui-colors-black,#000);}.css-1mcymz .gatsby-highlight pre[class~="language-tsx"]:before{content:"tsx";background:#61dafb;color:var(--theme-ui-colors-black,#000);}.css-1mcymz .gatsby-highlight pre[class~="language-html"]:before{content:"html";background:#005a9c;color:var(--theme-ui-colors-white,#fff);}.css-1mcymz .gatsby-highlight pre[class~="language-xml"]:before{content:"xml";background:#005a9c;color:var(--theme-ui-colors-white,#fff);}.css-1mcymz .gatsby-highlight pre[class~="language-svg"]:before{content:"svg";background:#005a9c;color:var(--theme-ui-colors-white,#fff);}.css-1mcymz .gatsby-highlight pre[class~="language-graphql"]:before{content:"GraphQL";background:#E10098;}.css-1mcymz .gatsby-highlight pre[class~="language-css"]:before{content:"css";background:#ff9800;color:var(--theme-ui-colors-black,#000);}.css-1mcymz .gatsby-highlight pre[class~="language-mdx"]:before{content:"mdx";background:#f9ac00;color:var(--theme-ui-colors-black,#000);}.css-1mcymz .gatsby-highlight pre[class~="language-php"]:before{content:"php";background:#777bb3;color:var(--theme-ui-colors-black,#000);}.css-1mcymz .gatsby-highlight pre[class~="language-py"]:before,.css-1mcymz .gatsby-highlight pre[class~="language-python"]:before{content:"py";background:#306998;color:var(--theme-ui-colors-white,#fff);}.css-1mcymz .gatsby-highlight pre[class~="language-text"]:before{content:"text";}.css-1mcymz .gatsby-highlight pre[class~='language-shell']:before{content:'shell';}.css-1mcymz .gatsby-highlight pre[class~='language-sh']:before{content:'sh';}.css-1mcymz .gatsby-highlight pre[class~='language-bash']:before{content:'bash';}.css-1mcymz .gatsby-highlight pre[class~='language-yaml']:before{content:'yaml';background:#ffa8df;}.css-1mcymz .gatsby-highlight pre[class~='language-yml']:before{content:'yml';background:#ffa8df;}.css-1mcymz .gatsby-highlight pre[class~='language-markdown']:before{content:'md';}.css-1mcymz .gatsby-highlight pre[class~='language-json']:before,.css-1mcymz .gatsby-highlight pre[class~='language-json5']:before{content:'json';background:linen;}.css-1mcymz .gatsby-highlight pre[class~='language-diff']:before{content:'diff';background:#e6ffed;}.css-1mcymz .gatsby-highlight > code[class*="language-"],.css-1mcymz .gatsby-highlight > pre[class=*="language-"]{word-spacing:normal;word-break:normal;overflow-wrap:normal;line-height:1.5;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;}.css-1mcymz .gatsby-highlight pre::-webkit-scrollbar{width:0.5rem;height:0.5rem;}.css-1mcymz .gatsby-highlight pre::-webkit-scrollbar-thumb{background-color:var(--theme-ui-colors-primary,#6b46c1);}.css-1mcymz .gatsby-highlight pre::-webkit-scrollbar-track{background:rgb(1,22,39);}.css-1mcymz .line-number-style{display:inline-block;width:3em;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;opacity:0.3;text-align:center;position:relative;}.css-1mcymz .code-title{background-color:#d2c7ec;color:var(--theme-ui-colors-black,#000);font-size:0.875rem;padding-left:1rem;padding-right:1rem;padding-top:0.5rem;padding-bottom:0.5rem;font-family:Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;margin-left:0;margin-right:0;}@media screen and (min-width:640px){.css-1mcymz .code-title{margin-left:0;margin-right:0;}}@media screen and (min-width:768px){.css-1mcymz .code-title{margin-left:0;margin-right:0;}}@media screen and (min-width:1024px){.css-1mcymz .code-title{margin-left:-1rem;margin-right:-1rem;}}.css-1mcymz [data-name='live-preview'],.css-1mcymz [data-name='live-editor']{margin-left:0;margin-right:0;font-size:1rem;}@media screen and (min-width:640px){.css-1mcymz [data-name='live-preview'],.css-1mcymz [data-name='live-editor']{margin-left:0;margin-right:0;font-size:1rem;}}@media screen and (min-width:768px){.css-1mcymz [data-name='live-preview'],.css-1mcymz [data-name='live-editor']{margin-left:0;margin-right:0;font-size:1.25rem;}}@media screen and (min-width:1024px){.css-1mcymz [data-name='live-preview'],.css-1mcymz [data-name='live-editor']{margin-left:-1rem;margin-right:-1rem;}}.css-1mcymz .token-line{padding-right:1rem;}.css-1mcymz .highlight-line{background-color:rgb(2,55,81);border-left:4px solid rgb(2,155,206);}.css-1mcymz .highlight-line .line-number-style{width:calc(3em - 4px);opacity:0.5;left:-2px;}.css-1mcymz .react-live-wrapper{position:relative;}.css-1mcymz .react-live-wrapper .code-copy-button{right:0;}@media screen and (min-width:640px){.css-1mcymz .react-live-wrapper .code-copy-button{right:0;}}@media screen and (min-width:768px){.css-1mcymz .react-live-wrapper .code-copy-button{right:0;}}@media screen and (min-width:1024px){.css-1mcymz .react-live-wrapper .code-copy-button{right:-1rem;}}</style><div id="skip-nav" class=" css-1mcymz"><style data-emotion-css="863s1o">.css-863s1o{box-sizing:border-box;margin:0;min-width:0;font-family:inherit;font-weight:700;line-height:1.25;font-family:inherit;font-weight:700;line-height:1.25;margin:0;margin-bottom:0.25rem;font-size:2.25rem;margin-top:2rem;color:var(--theme-ui-colors-heading,#000);}@media screen and (min-width:640px){.css-863s1o{font-size:3rem;}}@media screen and (min-width:768px){.css-863s1o{font-size:3rem;}}@media screen and (min-width:1024px){.css-863s1o{font-size:4rem;}}</style><h1 class="css-863s1o">Yarn2 with PnP 升级指北</h1><style data-emotion-css="1fkzbc2">.css-1fkzbc2{color:var(--theme-ui-colors-secondary,#5f6c80);margin-top:1rem;font-size:1rem;}.css-1fkzbc2 a{color:var(--theme-ui-colors-secondary,#5f6c80);}@media screen and (min-width:640px){.css-1fkzbc2{font-size:1rem;}}@media screen and (min-width:768px){.css-1fkzbc2{font-size:1.25rem;}}</style><p class="css-1fkzbc2"><time>12.01.2021</time> — <a class="css-688a3f" href="/treasure-bucket/tags/tools">tools</a> — <span>2<!-- --> min read</span></p><style data-emotion-css="f0b8g7">.css-f0b8g7{margin-top:4rem;margin-bottom:4rem;}.css-f0b8g7 .gatsby-resp-image-wrapper{margin-top:2rem;margin-bottom:2rem;box-shadow:rgba(0,0,0,0.15) 0px 32px 32px 0px,rgba(0,0,0,0.15) 0px 16px 16px 0px,rgba(0,0,0,0.15) 0px 8px 8px 0px,rgba(0,0,0,0.15) 0px 4px 4px 0px;}@media screen and (min-width:640px){.css-f0b8g7 .gatsby-resp-image-wrapper{margin-top:2rem;margin-bottom:2rem;}}@media screen and (min-width:768px){.css-f0b8g7 .gatsby-resp-image-wrapper{margin-top:4rem;margin-bottom:4rem;}}</style><section class="css-f0b8g7"><style data-emotion-css="1ccrm8j">.css-1ccrm8j{font-size:1rem;-webkit-letter-spacing:-0.003em;-moz-letter-spacing:-0.003em;-ms-letter-spacing:-0.003em;letter-spacing:-0.003em;line-height:1.625;--baseline-multiplier:0.179;--x-height-multiplier:0.35;word-break:break-word;}@media screen and (min-width:640px){.css-1ccrm8j{font-size:1rem;}}@media screen and (min-width:768px){.css-1ccrm8j{font-size:1.25rem;}}</style><p class="css-1ccrm8j"><style data-emotion-css="1od09yo">.css-1od09yo{color:var(--theme-ui-colors-primary,#6b46c1);-webkit-text-decoration:none;text-decoration:none;}.css-1od09yo:hover{-webkit-text-decoration:underline;text-decoration:underline;}</style><a href="https://link.zhihu.com/?target=http%3A//yarnpkg.com/" class="css-1od09yo">Yarn</a>  作为 JavaScript 生态的一个强大的依赖管理工具，在去年年初就正式发布了 V2 版本，但就当时的表现情况来看稳定性属实不高。时间一晃已经到了 2021 年，随着去年<code class="css-0">webpack5</code>，<code class="css-0">vite</code>，<code class="css-0">snowpack</code>等构建工具的升级与创新，前端的效能模块也有了比较大的进步空间，因此笔者准备对构建工具与 Yarn with PnP 协同进行前端工程化的整体链路提效，于是就记录下此文。</p><style data-emotion-css="7tlrlz">.css-7tlrlz{font-family:inherit;font-weight:700;line-height:1.25;margin:0;margin-bottom:0.25rem;font-size:1.875rem;margin-top:2rem;color:var(--theme-ui-colors-heading,#000);}@media screen and (min-width:640px){.css-7tlrlz{font-size:2.25rem;}}@media screen and (min-width:768px){.css-7tlrlz{font-size:2.25rem;}}@media screen and (min-width:1024px){.css-7tlrlz{font-size:3rem;}}</style><h2 class="css-7tlrlz">现状与痛点</h2><p class="css-1ccrm8j">Yarn 团队开发 PnP 特性最直接的原因就是现有的依赖管理方式效率太低。引用依赖时慢，安装依赖时也慢。</p><p class="css-1ccrm8j">而且我们在执行 <code class="css-0">yarn install</code> 操作会执行以下四个步骤</p><style data-emotion-css="15rlv7r">.css-15rlv7r li{font-size:1rem;-webkit-letter-spacing:-0.003em;-moz-letter-spacing:-0.003em;-ms-letter-spacing:-0.003em;letter-spacing:-0.003em;line-height:1.625;--baseline-multiplier:0.179;--x-height-multiplier:0.35;}@media screen and (min-width:640px){.css-15rlv7r li{font-size:1rem;}}@media screen and (min-width:768px){.css-15rlv7r li{font-size:1.25rem;}}</style><ol class="css-15rlv7r"><li class="css-0">将依赖包的版本区间解析为某个具体的版本号</li><li class="css-0">下载对应版本依赖的 tar 包到本地离线镜像</li><li class="css-0">将依赖从离线镜像解压到本地缓存</li><li class="css-0">将依赖从缓存拷贝到当前目录的 <code class="css-0">node_modules</code> 目录</li></ol><p class="css-1ccrm8j">其中第 4 步同样涉及大量的文件 I/O，导致安装依赖时效率不高（尤其是在 CI 环境，每次都需要安装全部依赖）。</p><style data-emotion-css="1gtwvjp">.css-1gtwvjp{border-left-color:var(--theme-ui-colors-primary,#6b46c1);border-left-style:solid;border-left-width:6px;margin-left:0;margin-right:0;padding-left:2rem;}.css-1gtwvjp p{font-style:italic;}</style><blockquote class="css-1gtwvjp"><p class="css-1ccrm8j">PS: 为啥有时候我们感觉本地安装会很快？因为现在大多数开发我们都使用 mac，mac 的存储设备为固态硬盘。其实无论是否是 mac，只要在纯固态硬盘坏境下操作，速度确实还不错，但在 CI 环境是硬伤</p></blockquote><p class="css-1ccrm8j"><code class="css-0">Plug’n’Play</code> ，作为重头戏，由此而生! 它是能彻底解决问题同时还可以与现有生态兼容的解决方案。</p><h2 class="css-7tlrlz">新特性</h2><style data-emotion-css="1p1kpni">.css-1p1kpni{font-family:inherit;font-weight:700;line-height:1.25;margin:0;margin-bottom:0.25rem;font-size:1.5rem;margin-top:2rem;color:var(--theme-ui-colors-heading,#000);}@media screen and (min-width:640px){.css-1p1kpni{font-size:1.875rem;}}@media screen and (min-width:768px){.css-1p1kpni{font-size:1.875rem;}}@media screen and (min-width:1024px){.css-1p1kpni{font-size:2.25rem;}}</style><h3 class="css-1p1kpni">可读性更好的输出日志</h3><p class="css-1ccrm8j">虽然相对于其他替代方案（例如 npm）Yarn 的输出日志的可读性算是比较高的了，可是它还是存在各种各样的问题，例如当输出信息特别多的时候，开发者很难在一大堆输出中找到有用的内容，而且输出日志的颜色并没有起到帮助用户快速识别出重要信息的作用，甚至还会对日志的阅读造成一定的干扰。基于这些原因，v2 版本对输出日志进行了一些改进，我们先来看一下它大概变成了什么样子了：</p><p class="css-1ccrm8j"><img src="../journal.png" alt="journal" class="css-0"/></p><h3 class="css-1p1kpni">PnP</h3><p class="css-1ccrm8j">PnP 的具体工作原理是，作为把依赖从缓存拷贝到 <code class="css-0">node_modules</code> 的替代方案，Yarn 会维护一张静态映射表，该表中包含了以下信息：</p><ul class="css-15rlv7r"><li class="css-0">当前依赖树中包含了哪些依赖包的哪些版本</li><li class="css-0">这些依赖包是如何互相关联的</li><li class="css-0">这些依赖包在文件系统中的具体位置</li></ul><p class="css-1ccrm8j">这个映射表在 Yarn 的 PnP 实现中对应项目目录中的 <code class="css-0">.pnp.js</code> 文件。</p><p class="css-1ccrm8j">这个 <code class="css-0">.pnp.js</code> 文件是如何生成，Yarn 又是如何利用它的呢？</p><p class="css-1ccrm8j">在安装依赖时，在第 3 步完成之后，Yarn 并不会拷贝依赖到 <code class="css-0">node_modules</code> 目录，而是会在 <code class="css-0">.pnp.js</code> 中记录下该依赖在缓存中的具体位置。这样就避免了大量的 I/O 操作同时项目目录也不会有 <code class="css-0">node_modules</code> 目录生成。</p><p class="css-1ccrm8j">同时 <code class="css-0">.pnp.js</code> 还包含了一个特殊的 resolver，Yarn 会利用这个特殊的 resolver 来处理 <code class="css-0">require()</code> 请求，该 resolver 会根据 <code class="css-0">.pnp.js</code> 文件中包含的静态映射表直接确定依赖在文件系统中的具体位置，从而避免了现有实现在处理依赖引用时的 I/O 操作。</p><style data-emotion-css="14fixdb">.css-14fixdb{font-family:inherit;font-weight:700;line-height:1.25;margin:0;margin-bottom:0.25rem;font-size:1.25rem;color:var(--theme-ui-colors-heading,#000);margin-top:1rem;}@media screen and (min-width:640px){.css-14fixdb{font-size:1.5rem;}}@media screen and (min-width:768px){.css-14fixdb{font-size:1.5rem;}}@media screen and (min-width:1024px){.css-14fixdb{font-size:1.875rem;}}</style><h4 class="css-14fixdb">带来的好处</h4><p class="css-1ccrm8j">从 PnP 的实现方案可以看出，同一个系统上不同项目引用的相同依赖的相同版本实际都是指向的缓存中的同一个目录。这带来了几个最直观的好处：</p><ul class="css-15rlv7r"><li class="css-0">安装依赖的速度得到了空前的提升 (第一次安装没啥感觉，之后安装的速度极快)</li><li class="css-0">CI 环境中多个 CI 实例可以共享同一份缓存</li><li class="css-0">同一个系统中的多个项目不再需要占用多份磁盘空间 (如 monorepo 中<code class="css-0">lerna</code> 模式)</li></ul><h2 class="css-7tlrlz">交互模式（interactive mode）</h2><p class="css-1ccrm8j">假如你要在项目的某个 workspace 中引入某个依赖，你可能要考虑其他 workspaces 是否也用到了这个依赖，而且要避免引入不兼容的版本。v2 版本中，你可以使用<code class="css-0">-i</code>参数来让<code class="css-0">yarn add</code>命令进入到交互模式，这样 yarn 就会帮你检查这个依赖有没有在其他 workspaces 中被使用，并且会让你选择是要复用其他 workspaces 中的依赖版本还是使用另外的版本。</p><p class="css-1ccrm8j">并且支持自动发布关联的 workspace，之前在 monorepo 开发模式下当某个包发布了新的版本之后，发布其它相关联的包十分麻烦。为了解决这个问题，Yarn v2 版本采取了和 Lerna 以及其他类似工具完全不同的解决方案，它把这部分逻辑放在了一个单独的叫做 <a href="https://next.yarnpkg.com/features/release-workflow" class="css-1od09yo">version 的插件</a>中。version 插件允许你将一部分包版本管理工作分发给你的代码贡献者，而且它还提供了一个友好的交互界面来让你十分容易地管理关联包的发布。</p><h2 class="css-7tlrlz">零安装（Zero-Installs）</h2><p class="css-1ccrm8j"><a href="https://next.yarnpkg.com/features/zero-installs" class="css-1od09yo">依赖零安装</a>更像是一个理念而不是一个功能，在我们安装完依赖后，依赖文件都缓存在项目文件夹中（.yarn/cache），只需确保将其上传到 git 即可完成零安装，同时保证依赖版本一致性。</p><p class="css-1ccrm8j">在我们运行<code class="css-0">yarn install</code>后，Yarn 将生成一个<code class="css-0">.pnp.js</code>文件。也将其添加到您的存储库，它包含 Node 将用于加载程序包的依赖关系树。</p><p class="css-1ccrm8j">看到这里你一定很惊讶，居然把整个<code class="css-0">node_modules</code>上传到 git 上，这个做法太疯狂。如果真的直接把 node_modules 提交到远端仓库的话，每次提交都是一个噩梦，因为 node_modules 的小文件很多，而且容量大。不仅每次提交下载而且合并冲突也是噩梦。</p><p class="css-1ccrm8j">为了解决这个问题，v2 版本默认开启了 Plug&#x27;n&#x27;Play + zip loading 的功能，这个功能开启后你的项目将不再存在 node_modules 文件夹，所有的依赖都会被压缩，并且体积很小，原本需要<code class="css-0">1.2</code>GB 的依赖，下载只需要<code class="css-0">150</code>MB。并且数量不会很多，一般都以<code class="css-0">包名+版本号+hash</code>命名。使用依赖零安装有哪些好处呢？</p><ul class="css-15rlv7r"><li class="css-0">dev<ul class="css-15rlv7r"><li class="css-0">代码 review 的时候可以非常清楚的看见哪些依赖发生了变化</li></ul></li><li class="css-0">更快，更简单，更稳定的 CI 部署<ul class="css-15rlv7r"><li class="css-0">每次部署代码时，依赖的 install 占用的时间一直是一个大头，去掉这个步骤，整个流水线速度会大大提升</li><li class="css-0">不会存在本地环境运行正常，而线上环境运行挂掉的问题</li></ul></li></ul><h2 class="css-7tlrlz">准备工作</h2><p class="css-1ccrm8j">首先升级到 yarn2+ 版本，此版本自带 PnP。</p><div class="gatsby-highlight" data-language="none"><pre class="prism-code language-none" style="color:#d6deeb;background-color:#011627" data-linenumber="true"><style data-emotion-css="l84w3r">.css-l84w3r{background-color:rgba(107,70,193,0.2);border:none;color:var(--theme-ui-colors-gray-2,#edf2f7);cursor:pointer;font-size:14px;font-family:"IBM Plex Sans",-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";-webkit-letter-spacing:0.025rem;-moz-letter-spacing:0.025rem;-ms-letter-spacing:0.025rem;letter-spacing:0.025rem;-webkit-transition:default;transition:default;position:absolute;top:0;right:0;z-index:1;border-radius:0 0 0 0.25rem;padding:0.25rem 0.6rem;}@media screen and (min-width:640px){.css-l84w3r{font-size:14px;}}@media screen and (min-width:768px){.css-l84w3r{font-size:16px;}}.css-l84w3r[disabled]{cursor:not-allowed;}.css-l84w3r:not([disabled]):hover{background-color:var(--theme-ui-colors-primary,#6b46c1);color:var(--theme-ui-colors-white,#fff);}</style><button type="button" name="copy code to clipboard" class="code-copy-button css-l84w3r">Copy<style data-emotion-css="1gy8470">.css-1gy8470{border:0;-webkit-clip:rect(0,0,0,0);clip:rect(0,0,0,0);height:1px;margin:-1px;overflow:hidden;padding:0;position:absolute;white-space:nowrap;width:1px;}</style><span aria-roledescription="status" class="css-1gy8470">copy code to clipboard</span></button><code class="language-none"><div class="token-line" style="color:#d6deeb"><span class="line-number-style">1</span><span class="token plain">npm install -g yarn@berry</span></div></code></pre></div><p class="css-1ccrm8j">开始前我们查看下当前的 yarn 版本号</p><div class="gatsby-highlight" data-language="none"><pre class="prism-code language-none" style="color:#d6deeb;background-color:#011627" data-linenumber="true"><button type="button" name="copy code to clipboard" class="code-copy-button css-l84w3r">Copy<span aria-roledescription="status" class="css-1gy8470">copy code to clipboard</span></button><code class="language-none"><div class="token-line" style="color:#d6deeb"><span class="line-number-style">1</span><span class="token plain">yarn -v // 2.4.0</span></div></code></pre></div><h2 class="css-7tlrlz">step1</h2><p class="css-1ccrm8j">由于 yarn2 和 yarn1 基本不兼容，所以为了避免 yarn1 的冲突，先清理掉项目的<code class="css-0">node_modules</code>，<code class="css-0">yarn.lock</code>，然后执行</p><div class="gatsby-highlight" data-language="none"><pre class="prism-code language-none" style="color:#d6deeb;background-color:#011627" data-linenumber="true"><button type="button" name="copy code to clipboard" class="code-copy-button css-l84w3r">Copy<span aria-roledescription="status" class="css-1gy8470">copy code to clipboard</span></button><code class="language-none"><div class="token-line" style="color:#d6deeb"><span class="line-number-style">1</span><span class="token plain">// yarn &gt; 1.22</span></div><div class="token-line" style="color:#d6deeb"><span class="line-number-style">2</span><span class="token plain">yarn set version berry</span></div><div class="token-line" style="color:#d6deeb"><span class="line-number-style">3</span><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#d6deeb"><span class="line-number-style">4</span><span class="token plain">// yarn &lt; 1.22</span></div><div class="token-line" style="color:#d6deeb"><span class="line-number-style">5</span><span class="token plain">yarn policies set-version berry</span></div></code></pre></div><p class="css-1ccrm8j">执行后项目就被明确声明为 yarn2 项目。出现了<code class="css-0">.yarnrc.yml</code>文件与<code class="css-0">.yarn</code>目录。</p><h2 class="css-7tlrlz">step2</h2><p class="css-1ccrm8j">之后的安装步骤和 <code class="css-0">yarn@1.x</code> 没啥区别，直接 <code class="css-0">yarn</code> 安装依赖即可</p><div class="gatsby-highlight" data-language="none"><pre class="prism-code language-none" style="color:#d6deeb;background-color:#011627" data-linenumber="true"><button type="button" name="copy code to clipboard" class="code-copy-button css-l84w3r">Copy<span aria-roledescription="status" class="css-1gy8470">copy code to clipboard</span></button><code class="language-none"><div class="token-line" style="color:#d6deeb"><span class="line-number-style">1</span><span class="token plain">yarn</span></div></code></pre></div><p class="css-1ccrm8j">笔者在安装过程中出现了报错，最后发现是项目文件夹顶层的<code class="css-0">User</code>文件夹仍然存在一份 <code class="css-0">yarn.lock</code> 所致，把其清除后重新安装依赖</p><h2 class="css-7tlrlz">step3</h2><p class="css-1ccrm8j">安装完毕后，我们可以看见<code class="css-0">node_modules</code>依然不复存在，代替它的是 .yarn 目录，里面有 cache、unplugged 以及外面一个 .pnp.js 我们的依赖在 .yarn 文件夹的 cache 目录中</p><div class="gatsby-highlight" data-language="none"><pre class="prism-code language-none" style="color:#d6deeb;background-color:#011627" data-linenumber="true"><button type="button" name="copy code to clipboard" class="code-copy-button css-l84w3r">Copy<span aria-roledescription="status" class="css-1gy8470">copy code to clipboard</span></button><code class="language-none"><div class="token-line" style="color:#d6deeb"><span class="line-number-style">1</span><span class="token plain">.yarn</span></div><div class="token-line" style="color:#d6deeb"><span class="line-number-style">2</span><span class="token plain">├── cache // 项目依赖文件，均变为一个个zip</span></div><div class="token-line" style="color:#d6deeb"><span class="line-number-style">3</span><span class="token plain">├── releases</span></div><div class="token-line" style="color:#d6deeb"><span class="line-number-style">4</span><span class="token plain">├── sdks // IDE对PnP的支持，一般是针对ts,eslint prettier等</span></div><div class="token-line" style="color:#d6deeb"><span class="line-number-style">5</span><span class="token plain">│   └── eslint</span></div><div class="token-line" style="color:#d6deeb"><span class="line-number-style">6</span><span class="token plain">│   └── typescript</span></div><div class="token-line" style="color:#d6deeb"><span class="line-number-style">7</span><span class="token plain">│   └── integrations.yml</span></div><div class="token-line" style="color:#d6deeb"><span class="line-number-style">8</span><span class="token plain">├── unplugged // 需要调试的项目依赖，和node_modules里一样，有完整内容</span></div><div class="token-line" style="color:#d6deeb"><span class="line-number-style">9</span><span class="token plain">├── build-state.yml</span></div><div class="token-line" style="color:#d6deeb"><span class="line-number-style">10</span><span class="token plain">├── install-state.gz</span></div></code></pre></div><h2 class="css-7tlrlz">Tips</h2><h3 class="css-1p1kpni">私有库设置</h3><p class="css-1ccrm8j">如果你使用的库需要从私有源拉取，请先查看并更改 yarn 配置。更改 yarn 源，由于和 Yarn 1.x 的配置差异挺大，全部的配置可查阅<a href="https://yarnpkg.com/configuration/yarnrc" class="css-1od09yo">官方配置文档</a>，本文对私有源配置做一个示例：</p><div class="gatsby-highlight" data-language="none"><pre class="prism-code language-none" style="color:#d6deeb;background-color:#011627" data-linenumber="true"><button type="button" name="copy code to clipboard" class="code-copy-button css-l84w3r">Copy<span aria-roledescription="status" class="css-1gy8470">copy code to clipboard</span></button><code class="language-none"><div class="token-line" style="color:#d6deeb"><span class="line-number-style">1</span><span class="token plain">yarn config set npmRegistryServer http://registry.npm.dtstack.com</span></div></code></pre></div><p class="css-1ccrm8j">同时命令行修改的配置文件就是当前工作区的<code class="css-0">.yarnrc.yml</code>文件，因此也可以直接修改此文件。</p><p class="css-1ccrm8j">由于源不是 HTTPS，因此还需要设置进入白名单,我原本直接把 URI 设置入白名单，发现并没有什么用，查看了 yarn 源码后发现取的是<code class="css-0">URL.hostname</code>，因此我们应该如下设置，配置项也支持模糊匹配。</p><div class="gatsby-highlight" data-language="none"><pre class="prism-code language-none" style="color:#d6deeb;background-color:#011627" data-linenumber="true"><button type="button" name="copy code to clipboard" class="code-copy-button css-l84w3r">Copy<span aria-roledescription="status" class="css-1gy8470">copy code to clipboard</span></button><code class="language-none"><div class="token-line" style="color:#d6deeb"><span class="line-number-style">1</span><span class="token plain">yarn config set unsafeHttpWhitelist registry.npm.dtstack.com</span></div></code></pre></div><p class="css-1ccrm8j">完成上述配置后，文件应该含有以下内容：</p><div class="gatsby-highlight" data-language="none"><pre class="prism-code language-none" style="color:#d6deeb;background-color:#011627" data-linenumber="true"><button type="button" name="copy code to clipboard" class="code-copy-button css-l84w3r">Copy<span aria-roledescription="status" class="css-1gy8470">copy code to clipboard</span></button><code class="language-none"><div class="token-line" style="color:#d6deeb"><span class="line-number-style">1</span><span class="token plain">// .yarnrc.yml</span></div><div class="token-line" style="color:#d6deeb"><span class="line-number-style">2</span><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#d6deeb"><span class="line-number-style">3</span><span class="token plain">npmRegistryServer: &quot;http://registry.npm.dtstack.com&quot;</span></div><div class="token-line" style="color:#d6deeb"><span class="line-number-style">4</span><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#d6deeb"><span class="line-number-style">5</span><span class="token plain">unsafeHttpWhitelist: registry.npm.dtstack.com</span></div><div class="token-line" style="color:#d6deeb"><span class="line-number-style">6</span><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#d6deeb"><span class="line-number-style">7</span><span class="token plain">yarnPath: .yarn/releases/yarn-berry.cjs</span></div></code></pre></div><h3 class="css-1p1kpni">依赖安装失败</h3><p class="css-1ccrm8j">yarn2 的输出日志可读性还是比较高的，可以从<a href="https://yarnpkg.com/advanced/error-codes#yn0009---build_failed" class="css-1od09yo">状态码说明</a>找到解决问题的思路。</p><p class="css-1ccrm8j">笔者遇到的错误代码是<em class="css-0">YN0009 - <code class="css-0">BUILD_FAILED</code></em> ，日志输出的内容为项目 workspace 构建失败，经过查找发现是项目 <code class="css-0">package.json</code> 中的 script 含有<code class="css-0">/.*npm.*/</code>相关内容所致。
错误日志如图：</p><p class="css-1ccrm8j"><img src="../errorInfo.png" alt="errorInfo" class="css-0"/></p><h3 class="css-1p1kpni">node_modules 相关</h3><p class="css-1ccrm8j">现在项目不再有 node_modules 文件夹，也没有对应的 .bin 文件，之前依赖这些的文件只需要修改为 <code class="css-0">yarn run</code> 即可正常运行。</p><p class="css-1ccrm8j">例如：</p><div class="gatsby-highlight" data-language="node"><pre class="prism-code language-node" style="color:#d6deeb;background-color:#011627" data-linenumber="true"><button type="button" name="copy code to clipboard" class="code-copy-button css-l84w3r">Copy<span aria-roledescription="status" class="css-1gy8470">copy code to clipboard</span></button><code class="language-node"><div class="token-line" style="color:#d6deeb"><span class="line-number-style">1</span><span class="token plain">node --max_old_space_size=4092 ./node_modules/.bin/webpack-dev-server --inline --config build/dev.js --open</span></div></code></pre></div><p class="css-1ccrm8j">修改为</p><div class="gatsby-highlight" data-language="node"><pre class="prism-code language-node" style="color:#d6deeb;background-color:#011627" data-linenumber="true"><button type="button" name="copy code to clipboard" class="code-copy-button css-l84w3r">Copy<span aria-roledescription="status" class="css-1gy8470">copy code to clipboard</span></button><code class="language-node"><div class="token-line" style="color:#d6deeb"><span class="line-number-style">1</span><span class="token plain">yarn run webpack-dev-server --max_old_space_size=4092  --inline --config build/dev.js --open</span></div></code></pre></div><p class="css-1ccrm8j">如果项目用有直接调用 <code class="css-0">node</code> 的内容也需要更改为使用 <code class="css-0">yarn node</code> 启动</p><h3 class="css-1p1kpni">调试依赖</h3><p class="css-1ccrm8j">同上文，在 PnP 模式下由于依赖都指向了全局缓存，我们不再可以直接修改这些依赖。针对这种场景，Yarn 提供了 <code class="css-0">yarn unplug [packageName]</code> 来将某个指定依赖拷贝到项目中的 <code class="css-0">.yarn/unplugged</code> 目录下。其实是在 <code class="css-0">package.json</code> 中写入了以下配置：</p><div class="gatsby-highlight" data-language="none"><pre class="prism-code language-none" style="color:#d6deeb;background-color:#011627" data-linenumber="true"><button type="button" name="copy code to clipboard" class="code-copy-button css-l84w3r">Copy<span aria-roledescription="status" class="css-1gy8470">copy code to clipboard</span></button><code class="language-none"><div class="token-line" style="color:#d6deeb"><span class="line-number-style">1</span><span class="token plain">&quot;dependenciesMeta&quot;: {</span></div><div class="token-line" style="color:#d6deeb"><span class="line-number-style">2</span><span class="token plain">    &quot;node-sass&quot;: {</span></div><div class="token-line" style="color:#d6deeb"><span class="line-number-style">3</span><span class="token plain">      &quot;built&quot;: false</span></div><div class="token-line" style="color:#d6deeb"><span class="line-number-style">4</span><span class="token plain">    },</span></div><div class="token-line" style="color:#d6deeb"><span class="line-number-style">5</span><span class="token plain">    &quot;webpack@4.46.0&quot;: {</span></div><div class="token-line" style="color:#d6deeb"><span class="line-number-style">6</span><span class="token plain">      &quot;unplugged&quot;: true</span></div><div class="token-line" style="color:#d6deeb"><span class="line-number-style">7</span><span class="token plain">    },</span></div><div class="token-line" style="color:#d6deeb"><span class="line-number-style">8</span><span class="token plain">    &quot;webpack-dev-server@3.11.2&quot;: {</span></div><div class="token-line" style="color:#d6deeb"><span class="line-number-style">9</span><span class="token plain">      &quot;unplugged&quot;: true</span></div><div class="token-line" style="color:#d6deeb"><span class="line-number-style">10</span><span class="token plain">    }</span></div><div class="token-line" style="color:#d6deeb"><span class="line-number-style">11</span><span class="token plain">  },</span></div></code></pre></div><p class="css-1ccrm8j">之后 <code class="css-0">.pnp.js</code> 中的 resolver 就会自动加载这个 unplug 的版本。</p><p class="css-1ccrm8j">调试完毕后，再执行 <code class="css-0">yarn unplug --clear packageName</code> 可移除本地 <code class="css-0">.pnp/unplugged</code> 中的对应依赖。</p><h3 class="css-1p1kpni">Webpack4 相关</h3><p class="css-1ccrm8j">Webpack5 本身已经支持 PnP，但是如果使用的 Webpack4 就需要安装<a href="https://github.com/arcanis/pnp-webpack-plugin" class="css-1od09yo"><code class="css-0">pnp-webpack-plugin</code></a>插件</p><h3 class="css-1p1kpni">IDE 支持</h3><p class="css-1ccrm8j">如果使用的是 VsCode，要点是</p><ol class="css-15rlv7r"><li class="css-0">安装<a href="https://marketplace.visualstudio.com/items?itemName=arcanis.vscode-zipfs" class="css-1od09yo">ZipFS</a> VSCode 扩展</li><li class="css-0">确保<code class="css-0">typescript</code>，<code class="css-0">eslint</code>，<code class="css-0">prettier</code>等使用的 IDE 扩展所有相关性在<code class="css-0">top level</code>项目（而不是随机的工作空间）</li><li class="css-0">Run <code class="css-0">yarn dlx @yarnpkg/pnpify --sdk vscode</code></li><li class="css-0">对这些变更就行 git commit，其他人就不必遵循相同的过程</li><li class="css-0">对于 TypeScript，不要忘记在 VSCode 中选择 <a href="https://code.visualstudio.com/docs/typescript/typescript-compiling#_using-the-workspace-version-of-typescript" class="css-1od09yo">Use Workspace Version</a>。</li></ol><p class="css-1ccrm8j">更多关于IDE的支持说明 <a href="https://yarnpkg.com/getting-started/editor-sdks" class="css-1od09yo">yarn官网</a> 有详细对IDE支持的说明</p><h3 class="css-1p1kpni">Cannot find module <!-- -->[...]</h3><p class="css-1ccrm8j">由于某些<code class="css-0">package</code>的依赖关系可能未正确指定。例如，运行过程中发现缺少一个依赖关系，导致Yarn拒绝对其进行访问。笔者目前在webpack-dev-server运行后日志也出现了此问题，来源自我司内部维护的一个依赖。</p><p class="css-1ccrm8j">针对这种情况，配置文件中的<code class="css-0">packageExtensions</code>字段提供了一种扩展包定义的方法。当然也可以向官方提PR完善其<code class="css-0">plugin-compat</code>数据库</p><div class="gatsby-highlight" data-language=""><pre class="prism-code language-" style="color:#d6deeb;background-color:#011627" data-linenumber="true"><button type="button" name="copy code to clipboard" class="code-copy-button css-l84w3r">Copy<span aria-roledescription="status" class="css-1gy8470">copy code to clipboard</span></button><code class="language-"><div class="token-line" style="color:#d6deeb"><span class="line-number-style">1</span><span class="token plain">// 扩展名仅应用与其版本与范围匹配的软件包，所以无论软件包来自何处都没有区别，仅仅是版本重要</span></div><div class="token-line" style="color:#d6deeb"><span class="line-number-style">2</span><span class="token plain">packageExtensions:</span></div><div class="token-line" style="color:#d6deeb"><span class="line-number-style">3</span><span class="token plain">    webpack@*:</span></div><div class="token-line" style="color:#d6deeb"><span class="line-number-style">4</span><span class="token plain">        dependencies:</span></div><div class="token-line" style="color:#d6deeb"><span class="line-number-style">5</span><span class="token plain">            lodash: &quot;^4.15.0&quot;</span></div><div class="token-line" style="color:#d6deeb"><span class="line-number-style">6</span><span class="token plain">        peerDependencies:</span></div><div class="token-line" style="color:#d6deeb"><span class="line-number-style">7</span><span class="token plain">            webpack-cli: &quot;*&quot;</span></div></code></pre></div><p class="css-1ccrm8j">但由于笔者从日志处发现缺失的依赖还是有一定数量级的错误，因此我停滞在此</p><h3 class="css-1p1kpni">项目启动失败</h3><p class="css-1ccrm8j">由于存在上文所述有依赖没有实现<code class="css-0">PnP</code>规范，所以会导致工程还是跑不起来，那我们是不是只能倒退回yarn 1.x了？当然不会，Yarn2提供了两种安装方式：</p><ul class="css-15rlv7r"><li class="css-0">PnP （默认）</li><li class="css-0">node-modules</li></ul><div class="gatsby-highlight" data-language=""><pre class="prism-code language-" style="color:#d6deeb;background-color:#011627" data-linenumber="true"><button type="button" name="copy code to clipboard" class="code-copy-button css-l84w3r">Copy<span aria-roledescription="status" class="css-1gy8470">copy code to clipboard</span></button><code class="language-"><div class="token-line" style="color:#d6deeb"><span class="line-number-style">1</span><span class="token plain"># .yarnrc.yml</span></div><div class="token-line" style="color:#d6deeb"><span class="line-number-style">2</span><span class="token plain">yarnPath: &quot;.yarn/releases/yarn-berry.js&quot;</span></div><div class="token-line" style="color:#d6deeb"><span class="line-number-style">3</span><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#d6deeb"><span class="line-number-style">4</span><span class="token plain"># 如果工程跑不起来可以先尝试启动宽松模式：</span></div><div class="token-line" style="color:#d6deeb"><span class="line-number-style">5</span><span class="token plain">nodeLinker: &quot;pnp&quot;</span></div><div class="token-line" style="color:#d6deeb"><span class="line-number-style">6</span><span class="token plain">pnpMode: &quot;loose&quot; // 默认为&quot;strict&quot;，所有用到的依赖都必须显式地声明在package.json中</span></div><div class="token-line" style="color:#d6deeb"><span class="line-number-style">7</span><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#d6deeb"><span class="line-number-style">8</span><span class="token plain"># 如果仍然跑不起来，可以用下面的配置完全按照以前的依赖按照方式</span></div><div class="token-line" style="color:#d6deeb"><span class="line-number-style">9</span><span class="token plain">nodeLinker: &quot;node-modules&quot;</span></div></code></pre></div><h2 class="css-7tlrlz">总结</h2><p class="css-1ccrm8j">升级Yarn2的过程比我想象的要坎坷，踩了不少坑，翻阅了无数的issue，目前我停滞在因为依赖缺少而导致webpack启动失败的环节，我坚信它是成功迁移Yarn2的最后一步，但我相信在后续的不断学习中，此问题终将迎刃而解。问题解决后我会更新本文。</p><p class="css-1ccrm8j">虽然Yarn2看似带来了痛点的解决方案，并且作为其稳定版本的v2也已经发布一年了，但若把它作为当前产品的升级的模块之一，我认为还需观望；任何的产品的第一要点是稳定性，且都有或多或少的历史包袱亦或是产品引用的依赖实则已经不维护，例如：<code class="css-0">moment</code>; 他们都会成为升级yarn2过程中带隐患的雷区，况且版本切换几乎完全不兼容，撤回v1版本代价也比较大，综上所述，不推荐产品现在升级，但是周期项目或是脚手架可以进行实装。</p><h4 class="css-14fixdb">参考链接</h4><ul class="css-15rlv7r"><li class="css-0"><a href="https://github.com/yarnpkg/yarn/issues/6953" class="css-1od09yo">Yarn’s Future - v2 and beyond</a></li><li class="css-0"><a href="https://github.com/yarnpkg/rfcs/pull/101" class="css-1od09yo">Yarn Plug’n’Play: Getting rid of node_modules</a></li><li class="css-0"><a href="https://github.com/yarnpkg/rfcs/files/2378943/Plugnplay.pdf" class="css-1od09yo">Plug’n’Play Whitepaper</a></li><li class="css-0"><a href="https://github.com/yarnpkg/yarn/pull/6382" class="css-1od09yo">Yarn Plug’n’Play: Implementation</a></li><li class="css-0"><a href="https://yarnpkg.com/en/docs/pnp" class="css-1od09yo">Yarn Website</a></li></ul></section></div><style data-emotion-css="6x8z6y">.css-6x8z6y{box-sizing:border-box;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;margin-top:8rem;color:var(--theme-ui-colors-secondary,#5f6c80);-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;border-top-style:solid;border-top-width:1px;border-top-color:var(--theme-ui-colors-divide,#cbd5e0);padding-top:1rem;}.css-6x8z6y a{color:var(--theme-ui-colors-secondary,#5f6c80);-webkit-text-decoration:none;text-decoration:none;}.css-6x8z6y a:hover{color:var(--theme-ui-colors-heading,#000);-webkit-text-decoration:underline;text-decoration:underline;}.css-6x8z6y a:focus{color:var(--theme-ui-colors-heading,#000);}@media screen and (min-width:640px){.css-6x8z6y{-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;}}@media screen and (min-width:768px){.css-6x8z6y{-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;}}</style><footer class="css-6x8z6y"><div>© <!-- -->2021<!-- --> by <!-- -->treasure-bucket<!-- -->. All rights reserved.</div><div><a aria-label="Link to the theme&#x27;s GitHub repository" href="https://github.com/LekoArts/gatsby-themes/tree/master/themes/gatsby-theme-minimal-blog" class="css-688a3f">Theme</a> <!-- -->by<!-- --> <a aria-label="Link to the theme author&#x27;s website" href="https://www.lekoarts.de/en" class="css-688a3f">LekoArts</a></div></footer></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/yarn-2-with-pn-p-升级指北";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"polyfill":["/polyfill-da20a1db8321d70d55d6.js"],"app":["/app-60b63f4aa4ff97feea58.js"],"component---cache-caches-gatsby-plugin-offline-app-shell-js":["/component---cache-caches-gatsby-plugin-offline-app-shell-js-b0556ce5127c1a3e2490.js"],"component---node-modules-lekoarts-gatsby-theme-minimal-blog-core-src-templates-blog-query-tsx":["/component---node-modules-lekoarts-gatsby-theme-minimal-blog-core-src-templates-blog-query-tsx-970be14a9aae153925c1.js"],"component---node-modules-lekoarts-gatsby-theme-minimal-blog-core-src-templates-page-query-tsx":["/component---node-modules-lekoarts-gatsby-theme-minimal-blog-core-src-templates-page-query-tsx-da5badcd02e605b3817c.js"],"component---node-modules-lekoarts-gatsby-theme-minimal-blog-core-src-templates-post-query-tsx":["/component---node-modules-lekoarts-gatsby-theme-minimal-blog-core-src-templates-post-query-tsx-57f99312ad0f0ecc6f98.js"],"component---node-modules-lekoarts-gatsby-theme-minimal-blog-core-src-templates-tag-query-tsx":["/component---node-modules-lekoarts-gatsby-theme-minimal-blog-core-src-templates-tag-query-tsx-520ec8a61aa076c4868e.js"],"component---node-modules-lekoarts-gatsby-theme-minimal-blog-core-src-templates-tags-query-tsx":["/component---node-modules-lekoarts-gatsby-theme-minimal-blog-core-src-templates-tags-query-tsx-235f8d6a5050889db42d.js"]};/*]]>*/</script><script src="/treasure-bucket/polyfill-da20a1db8321d70d55d6.js" nomodule=""></script><script src="/treasure-bucket/component---node-modules-lekoarts-gatsby-theme-minimal-blog-core-src-templates-post-query-tsx-57f99312ad0f0ecc6f98.js" async=""></script><script src="/treasure-bucket/3d790d178db05b259e575ef93b2a0dbea1270f59-550e32192ffced72d3f6.js" async=""></script><script src="/treasure-bucket/styles-e9d24b1846c7d6eb9685.js" async=""></script><script src="/treasure-bucket/app-60b63f4aa4ff97feea58.js" async=""></script><script src="/treasure-bucket/framework-305b3707783ccc9d7ca6.js" async=""></script><script src="/treasure-bucket/webpack-runtime-fbceaeb12a518fe97111.js" async=""></script></body></html>